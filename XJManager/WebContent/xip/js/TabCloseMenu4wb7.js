Ext.define("Ext.ux.TabCloseMenu",{alias:"plugin.tabclosemenu",mixins:{observable:"Ext.util.Observable"},closeTabText:"关闭当前页签",showCloseOthers:true,closeOthersTabsText:"关闭其他页签",showCloseAll:true,closeAllTabsText:"关闭所有页签",extraItemsHead:null,extraItemsTail:null,constructor:function(a){this.addEvents("aftermenu","beforemenu");this.mixins.observable.constructor.call(this,a)},init:function(a){this.tabPanel=a;this.tabBar=a.down("tabbar");this.mon(this.tabPanel,{scope:this,afterlayout:this.onAfterLayout,single:true})},onAfterLayout:function(){this.mon(this.tabBar.el,{scope:this,contextmenu:this.onContextMenu,delegate:".x-tab"})},onBeforeDestroy:function(){Ext.destroy(this.menu);this.callParent(arguments)},onContextMenu:function(d,f){var c=this,g=c.createMenu(),e=true,h=true,b=c.tabBar.getChildByElement(f),a=c.tabBar.items.indexOf(b);this.item=c.tabPanel.getComponent(a);c.selectedTab=c.tabPanel.getComponent(a);g.child('*[text="'+c.closeTabText+'"]').setDisabled(!c.item.closable);if(c.showCloseAll||c.showCloseOthers){c.tabPanel.items.each(function(i){if(i.closable){e=false;if(i!=c.item){h=false;return false}}return true});if(c.showCloseAll){g.child('*[text="'+c.closeAllTabsText+'"]').setDisabled(e)}if(c.showCloseOthers){g.child('*[text="'+c.closeOthersTabsText+'"]').setDisabled(h)}}d.preventDefault();c.fireEvent("beforemenu",g,c.item,c);g.showAt(d.getXY())},createMenu:function(){var b=this;if(!b.menu){var a=[{text:b.closeTabText,scope:b,handler:b.onClose}];if(b.showCloseAll||b.showCloseOthers){a.push("-")}if(b.showCloseOthers){a.push({text:b.closeOthersTabsText,scope:b,handler:b.onCloseOthers})}if(b.showCloseAll){a.push({text:b.closeAllTabsText,scope:b,handler:b.onCloseAll})}a.push("-");a.push({text:"收藏",scope:b,handler:b.onCollectFunctions});a.push({text:"刷新",scope:b,handler:b.onTabRefresh});a.push("-");a.push({text:"功能帮助",scope:b,handler:b.onShowFuncHelp});if(b.extraItemsHead){a=b.extraItemsHead.concat(a)}if(b.extraItemsTail){a=a.concat(b.extraItemsTail)}b.menu=Ext.create("Ext.menu.Menu",{items:a,listeners:{hide:b.onHideMenu,scope:b}})}return b.menu},onHideMenu:function(){var a=this;a.item=null;a.fireEvent("aftermenu",a.menu,a)},onClose:function(){this.tabPanel.remove(this.selectedTab)},onCloseOthers:function(){this.doClose(true)},onCloseAll:function(){this.doClose(false)},doClose:function(b){var a=[];this.tabPanel.items.each(function(c){if(c.closable){if(!b||c!=this.selectedTab){a.push(c)}}},this);Ext.each(a,function(c){this.tabPanel.remove(c)},this)},onCollectFunctions:function(){try{var d="";var a=this.selectedTab.bindFile;if(Ext.isEmpty(a)){d=""}if(a.indexOf("funId")!=-1){var c=a.split("funId=");d=c[1].split("&")[0]}if(Ext.isEmpty(d)||d=="undefined"||d==undefined){Ext.Msg.alert("提示","此功能不能被收藏");return}Wb.request({url:"m?xwl=xip/pub/favorite/data/saveFavorite",params:{funTreeId:d,funName:this.selectedTab.title},success:function(e){Ext.Msg.alert("提示","收藏成功!",function(){app.indexPanel.items.items[0].refreshPorlet("favorite")})}})}catch(b){}},onTabRefresh:function(){var a=this.selectedTab.bindFile;if(Ext.String.endsWith(a,".xwl")){Wb.open({url:"m?xwl="+a.slice(0,-4),title:this.selectedTab.title,reload:true,container:this.tabPanel})}else{Wb.open({url:a,title:this.selectedTab.title,reload:true,container:this.tabPanel})}},onShowFuncHelp:function(){var c="";var a=this.selectedTab.bindFile;if(Ext.isEmpty(a)){c=""}if(a.indexOf("funId")!=-1){var b=a.split("funId=");c=b[1].split("&")[0]}Xip.showFunHelpWin(c,"r",this.selectedTab.title)}});