{"inframe":false,"title":"待办处理页面","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"// session参数\nvar _userId = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\nvar _userName = request.getSession().getAttribute(\"XzSessionVars\").get('userName');\n\n// url参数\nvar _ctxPath = request.getContextPath() ;\nvar _taskId = request.getParameter(\"taskId\") ;\nvar _type = request.getParameter(\"type\") ;\n// 当前打开待办的Window窗口的ID信息\nvar _extWinId = request.getParameter(\"extWinId\") ;\n\n// 安全码(从邮件中链入)\nvar secCode = request.getParameter(\"secCode\") ;\n\n// 查询参数\nvar _title ;\nvar _fromUserName ;\nvar _attr1 ;\nvar _beginDate ;\nvar _insCode ;\nvar _bizId ;\nvar _taskState;\nvar archFlag = 'N';\nvar _createType ;\n\n// 判断是否已归档\nvar isArchSql = \"select count(1) as TOTAL from xip_wf_ins_task a where a.task_id = '\"+ _taskId + \"'\" ;\nvar rr = DbUtil.run(request, isArchSql);\n// var out=java.lang.System.out;\nwhile(rr.next()){\n  var total = rr.getInt(\"TOTAL\") ;\n  if(total.toString() === '0'){\n    archFlag = 'Y';\n  }\n}\n\nvar sql ;\nif(archFlag === 'Y'){\n  // 已归档\n  sql = \"SELECT XT.TASK_TITLE,XT.INSTANCE_CODE,XI.BUSINESS_ID,XT.BEGIN_DATE,XT.ATTRIBUTE1,XT.TASK_STATE,XT.CREATE_TYPE, \"+\n          \"(select b.emp_name from xip_pub_users a, xip_pub_emps b where a.emp_id = b.emp_id and a.user_id = xi.created_by) SUBMITTER \"+\n          \" FROM xip_wf_arch_task XT, xip_wf_arch_instance XI \"+\n          \" WHERE XT.INSTANCE_ID = XI.INSTANCE_ID AND XT.TASK_ID = '\"+ _taskId + \"'\";\n}else{\n  // 未归档\n  sql = \"SELECT XT.TASK_TITLE,XT.INSTANCE_CODE,XI.BUSINESS_ID,XT.BEGIN_DATE,XT.ATTRIBUTE1,XT.TASK_STATE,XT.CREATE_TYPE, \"+\n          \"(select b.emp_name from xip_pub_users a, xip_pub_emps b where a.emp_id = b.emp_id and a.user_id = xi.created_by) SUBMITTER \"+\n          \" FROM XIP_WF_INS_TASK XT, XIP_WF_PROCESS_INSTANCE XI \"+\n          \" WHERE XT.INSTANCE_ID = XI.INSTANCE_ID AND XT.TASK_ID = '\"+ _taskId + \"'\";  \n}\nvar rs=DbUtil.run(request, sql);\nwhile(rs.next()){\n  _title = rs.getString('TASK_TITLE');\n  _fromUserName = rs.getString('SUBMITTER');\n  _bizId = rs.getString('BUSINESS_ID');\n  _insCode = rs.getString('INSTANCE_CODE');\n  _beginDate = DateUtil.format(rs.getDate('BEGIN_DATE'), \"yyyy-MM-dd\");\n  _attr1 = rs.getString('ATTRIBUTE1');\n  _taskState = rs.getString('TASK_STATE') ;\n  _createType = rs.getString('CREATE_TYPE') ;\n}\n\nif(Wb.isEmpty(_attr1)){\n  _attr1 = \"\";\n}\n_attr1 = _attr1.replace(\"\\n\", \"\");\n\n// 将数据保存在sessio中\nrequest.setAttribute(\"userId\",_userId);\nrequest.setAttribute(\"userName\",_userName);\nrequest.setAttribute(\"contextPath\",_ctxPath);\nrequest.setAttribute(\"taskId\",_taskId);\nrequest.setAttribute(\"type\",_type);\nrequest.setAttribute(\"title\",_title);\nrequest.setAttribute(\"extWinId\",_extWinId);\nrequest.setAttribute(\"beginDate\",_beginDate);\nrequest.setAttribute(\"fromUserName\",_fromUserName);\nrequest.setAttribute(\"insCode\",_insCode);\nrequest.setAttribute(\"bizId\",_bizId);\nrequest.setAttribute(\"taskState\",_taskState);\nrequest.setAttribute(\"createType\",_createType);\nrequest.setAttribute(\"attribute1\",_attr1);\nrequest.setAttribute(\"secCode\",secCode);\nrequest.setAttribute(\"archFlag\",archFlag);","itemId":"module"},"events":{"initialize":"Ext.apply(app,{\n  initWindow:function(params){\n    Ext.apply(app, params);\n    /*app.wfTaskWindow = new Ext.window.Window(app.wfTaskWindow);\n    app.wfTaskWindow.setTitle(params.title);\n    app.wfTaskWindow.show();*/\n  }\n});"},"children":[{"configs":{"itemId":"existStore","url":"m?xwl=xip/pub/wftask/data/existSuggest"},"children":[],"expanded":false,"type":"store"},{"configs":{"layout":"border","itemId":"wfTaskContainer"},"children":[{"configs":{"region":"north","tagConfigs":"baseCls:'my-panel-no-border'\n","layout":"form","itemId":"northPanel","padding":"5","border":"false"},"events":{"afterrender":"//Wb.addLink(['workflow/util/taskUtil-debug.js'],function(){\nvar _taskState = '{#taskState#}';\nvar _attr1 = '{#attribute1#}';\nif (_taskState === 'closed') {\n  if (_attr1 !== null && _attr1 !== \"\") {\n    app.col21.columnWidth = 1;\n    app.col21.doLayout();\n    app.col22.hide();\n    app.col23.hide();\n    app.col24.hide();\n  } else {\n    app.tr2.hide();\n  }\n} else {\n  //var buttons = TaskUtil.createButtonsW7('{#taskId#}', '{#bizId#}', '{#insCode#}', '{#taskState#}');\n  var buttons = XipWf.createButtonsByTaskId('{#taskId#}', app.textArea, '{#insCode#}', '{#bizId#}', '{#taskState#}');\n  if (buttons !== null && buttons.length > 0) {\n    var _items = [];\n    var len = \"\";\n    for (var i = 0; i < buttons.length; i++) {\n      var rr = buttons[i];\n      rr.x = 5 * (i+1);\n      app.col24.add(rr);\n      app.col24.doLayout();\n      _items.push(rr);\n      len += rr.text;\n      if (i !== (buttons.length - 1)) {\n        _items.push('-');\n        //len += '-' ;\n      } else {\n        len += '#';\n      }\n    }\n    var _size = len.indexOf('#');\n    var btnLen = _size * 0.025;\n    \n    app.col24.columnWidth = btnLen;\n    if (_attr1 !== null && _attr1 !== \"\") {\n      app.col21.columnWidth = 0.35;\n      app.col22.columnWidth = 0.60 - btnLen;\n    } else {\n      app.tr1.hide();\n      app.col22.columnWidth = 0.60 - btnLen ;\n      app.col22.doLayout();\n    }\n  } else {\n    if (_attr1 !== null && _attr1 !== \"\") {\n      app.col21.columnWidth = 1;\n      app.col22.hide();\n      app.col23.hide();\n      app.col24.hide();\n    } else {\n      app.tr2.hide();\n      Wb.info('加载待办按钮出错，请重新打开待办！');\n    }\n  }\n  app.col24.doLayout();\n}\n//加载业务页面\n  //var formUrl = TaskUtil.getBizFormUrl('{#taskId#}');\n  var formUrl = XipWf.getBizFormUrl('{#taskId#}');\n  if (formUrl === null) {\n    formUrl = '{#contextPath#}/workflow/workitem/extTaskMain.jsp?taskId={#taskId#}&type={#type#}&insCode={#insCode#}&bizId={#bizId#}&secCode={#secCode#}&taskState={#taskState#}';\n  } else {\n    formUrl = formUrl + '&taskState={#taskState#}';\n  }\n  Ext.getDom('bizPanelFrame').src = formUrl;\n  \n//});\n//app.wfTaskWindow.setTitle('{#title#}');\n"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","height":"30","layout":"column","itemId":"tr1","border":"false"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","frame":"true","layout":"fit","columnWidth":".15","itemId":"col11","border":"false"},"children":[{"configs":{"hidden":"true","html":"<strong>待办发起人:<\/strong>  {#fromUserName#} ","itemId":"label1","x":"26"},"children":[],"expanded":false,"type":"label"},{"configs":{"labelWidth":"90","readOnly":"true","hidden":"true","value":"{#fromUserName#}","labelAlign":"right","itemId":"text1","fieldLabel":"流程发起人"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"90","readOnly":"true","hidden":"true","value":"{#title#}","labelAlign":"right","itemId":"text2","fieldLabel":"待办标题"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","frame":"true","layout":"fit","columnWidth":".15","itemId":"col13","border":"false"},"children":[{"configs":{"hidden":"true","html":"<strong>待办发起时间:<\/strong> {#beginDate#}","itemId":"label2"},"children":[],"expanded":false,"type":"label"},{"configs":{"labelWidth":"90","readOnly":"true","hidden":"true","value":"{#beginDate#}","labelAlign":"right","itemId":"text3","fieldLabel":"流程发起时间"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","frame":"true","layout":"fit","columnWidth":".3","itemId":"col21","border":"false"},"children":[{"configs":{"html":"<strong>备注:<\/strong> {#attribute1#}","itemId":"label3","x":"26"},"children":[],"expanded":false,"type":"label"},{"configs":{"labelWidth":"90","hidden":"true","value":"{#attribute1#}","labelAlign":"right","itemId":"textArea1","fieldLabel":"征询/委派备注"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","height":"30","layout":"column","itemId":"tr2","border":"false"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","frame":"true","layout":"fit","columnWidth":".38","itemId":"col22","border":"false"},"children":[{"configs":{"tagConfigs":"id:'taskAuditComment'","labelWidth":"90","width":"500","labelAlign":"right","itemId":"textArea","fieldLabel":"<strong>审批意见<\/strong>","y":"2","editable":"true"},"children":[{"configs":{"tagConfigs":"minWidth:450","height":"300","itemId":"pickComp"},"events":{"itemclick":"\n//   var picker = this.ownerCmp;\n//   picker.setValue(record.get('NAME'));\n//   picker.collapse();","tagEvents":"cellclick:function(grid,td,cellIndex,record,tr,rowIndex){\n if(cellIndex === 1){\n    \n      app.textArea.setValue(record.get('NAME')) ;\n      \n    app.textArea.collapse();\n\n  }else if(cellIndex === 2){\n      Wb.confirm('确定要删除此信息?',function(){\n       Wb.request({\n         url:'m?xwl=xip/pub/wftask/data/deleteSuggest',\n         params:{'USER_COMMENT':record.get('NAME')},\n         success:function(){\n           Wb.toast('删除成功！');\n           app.pickComp.getStore().removeAt(rowIndex);\n         },\n         failure:function(){\n           Wb.toast('删除失败！');\n         }\n       });\n    });\n    \n  }\n}\n"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","xtype":"rownumberer","align":"center","width":"45","itemId":"columnNum1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"常用意见","dataIndex":"NAME","itemId":"NAME2","flex":"1","tooltip":"双击选择常用意见"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"操作","width":"60","align":"center","itemId":"opts1","altText":"删除快速意见","renderer":"return '<img src=\"{#contextPath#}/wb/images/delete.gif\"/>';","tooltip":"删除快速意见"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xip/pub/wftask/data/getUserSuggest"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","frame":"true","layout":"fit","columnWidth":".018","itemId":"col23","border":"false"},"children":[{"configs":{"itemId":"addComment","y":"2","iconCls":"plus_icon","tooltip":"添加为常用意见"},"events":{"click":"var userComment = app.textArea.getValue();\nif(Ext.isEmpty(userComment)){\n  Wb.toast('请录入审批意见!');\n}else{\n  \n  app.existStore.load({params:{userComment:userComment},callback:function(){\n  \n  \n  var count=app.existStore.getAt(0).get('COUN');\n  if(count===0){\n  \n  Wb.request({\n    url:'m?xwl=xip/pub/wftask/data/addFastSuggest',\n    params:{'userComment':userComment},\n    success:function(){\n      app.pickComp.store.load();\n      Wb.toast('常用信息保存成功！');\n    }\n  });\n  }else{\n   Wb.toast('常用信息保存成功！');\n  }\n  \n  }});\n  \n  \n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","layout":"column","columnWidth":"0.08","itemId":"col24","border":"false"},"children":[],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"region":"center","itemId":"centerTabPanel","border":"false"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","title":"业务详情","layout":"fit","html":"<iframe id=bizPanelFrame width=100% height=100% frameborder=0 scrolling=yes><\/iframe>","itemId":"taskPanel"},"children":[],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","title":"审批历史记录","frame":"true","layout":"fit","itemId":"approverPanel","border":"false"},"children":[{"configs":{"itemId":"approveGrid"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","xtype":"rownumberer","width":"45","align":"center","itemId":"approveNum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"待办所有者","dataIndex":"ASSIGNUSERNAME","itemId":"assignUserName","flex":"120"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"待办执行人","dataIndex":"EXECUTEUSERNAME","itemId":"executeUserName","flex":"120"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"审批阶段","width":"100","dataIndex":"ACTNAME","itemId":"actName"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"开始阶段","width":"120","dataIndex":"BEGINDATE","format":"Y-m-d H:i:s","itemId":"beginDate"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"结束时间","width":"120","dataIndex":"ENDDATE","format":"Y-m-d H:i:s","itemId":"endDate"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"待办状态","width":"80","dataIndex":"TASKSTATE","itemId":"taskState","renderer":"if(value == 'open'){\n  value = '打开' ;\n}else if(value == 'hung-up'){\n  value = '挂起' ;\n}else if(value == 'closed'){\n  value = '关闭' ;\n}\nreturn value ; "},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"结果","width":"90","dataIndex":"RESULT","itemId":"result"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"待办分类","width":"100","dataIndex":"CREATETYPE","itemId":"createType","renderer":"if(value == 'normal'){\n  value = '正常待办' ;\n}else if(value == 'consult'){\n  value = '征询待办' ;\n}else if(value == 'copyto'){\n  value = '抄送待办' ;\n}else if(value == 'avoid'){\n  value = '规避待办' ;\n}else if(value == 'start'){\n  value = '提交人待办' ;\n}else{\n  return value ;\n}\nreturn value ;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"审批意见","width":"300","dataIndex":"APPROVECOMMNET","itemId":"approveCommnet"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xip/pub/wftask/data/getApprovedTaskList"},"events":{"beforeload":"if('{#archFlag#}' === 'Y'){\n  store.getProxy().url ='m?xwl=xip/pub/wftask/data/getArchHistoryList';  //已归档待办\n}else{\n  store.getProxy().url ='m?xwl=xip/pub/wftask/data/getApprovedTaskList';  //未归档待办\n}\nstore.getProxy().extraParams.varType = 'task';\nstore.getProxy().extraParams.insCode = '{#insCode#}';\nstore.getProxy().extraParams.taskId = '{#taskId#}';\n"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'\n","title":"流程监控","layout":"fit","html":"<iframe src={#contextPath#}/workflow/task/processMonitor.jsp?varType=task&taskId={#taskId#} width=100% height=100% frameborder=0><\/iframe>","itemId":"monitorPanel","border":"false"},"children":[],"expanded":true,"type":"panel"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"container"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}