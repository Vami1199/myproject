{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"itemId":"xip.weixin"},"children":[{"configs":{"script":"var ctxPath = request.getContextPath() ;\nvar currentUrl = request.getRequestURL().toString();\nvar queryStr = request.getQueryString();\nif (queryStr !== null) {\n  currentUrl = currentUrl.concat(\"?\").concat(queryStr);\n        }\nvar wxCasUrl = com.xzsoft.xip.platform.util.PlatformUtil.getCasServer();\nvar configMap = com.xzsoft.xip.weixin.PlatformWeixinUtil.getWxJsSdkParams(currentUrl);\nvar configParams = configMap.split(\"#&\");\nvar wxJsTicket = configParams[0];\nvar wxNonceStr = configParams[1];\nvar wxTimestamp = configParams[2];\nvar wxSignature = configParams[3];\nvar wxAppId = configParams[4];\nrequest.setAttribute(\"contextPath\",ctxPath);\nrequest.setAttribute(\"wxJsTicket\",wxJsTicket);\nrequest.setAttribute(\"wxNonceStr\",wxNonceStr);\nrequest.setAttribute(\"wxTimestamp\",wxTimestamp);\nrequest.setAttribute(\"wxSignature\",wxSignature);\nrequest.setAttribute(\"wxAppId\",wxAppId);\nrequest.setAttribute(\"wxCasUrl\",wxCasUrl);","itemId":"weixinServerScript"},"children":[],"expanded":false,"type":"serverscript"},{"configs":{"headerScript":"wx.config({\n  debug: false, //调试阶段建议开启\n  appId: '{#wxAppId#}',\n  timestamp: '{#wxTimestamp#}',\n  nonceStr: '{#wxNonceStr#}',\n  signature: '{#wxSignature#}',\n  jsApiList: [\n    /*\n            * 所有要调用的 API 都要加到这个列表中\n            * 这里以图像接口为例\n            */\n    'checkJsApi',\n    'onMenuShareTimeline',\n    'onMenuShareAppMessage',\n    'onMenuShareQQ',\n    'onMenuShareWeibo',\n    'onMenuShareQZone',\n    'hideMenuItems',\n    'showMenuItems',\n    'hideAllNonBaseMenuItem',\n    'showAllNonBaseMenuItem',\n    'translateVoice',\n    'startRecord',\n    'stopRecord',\n    'onRecordEnd',\n    'playVoice',\n    'pauseVoice',\n    'stopVoice',\n    'uploadVoice',\n    'downloadVoice',\n    'chooseImage',\n    'previewImage',\n    'uploadImage',\n    'downloadImage',\n    'getNetworkType',\n    'openLocation',\n    'getLocation',\n    'hideOptionMenu',\n    'showOptionMenu',\n    'closeWindow',\n    'scanQRCode',\n    'chooseWXPay',\n    'openProductSpecificView',\n    'addCard',\n    'chooseCard',\n    'openCard'\n  ]\n});\n//定义images用来保存选择的本地图片ID，和上传后的服务器图片ID\nvar images = {\n  localId: [],\n  serverId: []\n};\n/**\n *微信图片上传接口js \n *attCatCode:附件分类编码\n *srcId:业务主键\n *busNo：业务编码\n *orgId：组织ID\n *callback:回调函数\n *return：成功 {'flag':'1','msg':'文件上传成功！'}\n *       失败 {'flag':'0','msg':'没有找到授权的服务器信息！'}等\n */\nfunction wxChooseImage(attCatCode,srcId,busNo,orgId,callback){\n  wx.chooseImage ({\n    success : function(res){\n      images.localId = res.localIds;  //保存到images\n      wxUploadImage(attCatCode,srcId,busNo,orgId,callback);\n    }\n  });\n}\nfunction wxUploadImage(attCatCode,srcId,busNo,orgId,callback){\n  var i = 0, len = images.localId.length;\n  function wxUpload(){\n    wx.uploadImage({\n      localId: images.localId[i], \n      isShowProgressTips: 1, // 默认为1，显示进度提示\n      success: function (res) {\n        i++;\n        //保存serverId\n        images.serverId.push(res.serverId);\n        //若选择了多张图片，依次将这些图片上传到微信服务器，图片上传完毕后，再将图片下载到本地服务器\n        if(i < len){\n          wxUpload();\n        }else{\n          var tmp = images.serverId;\n          if (images.serverId.length === 0) {\n            Wb.message(\"你没有上传过文件，请先上传文件！\");\n            return;\n          }else{\n            //发送ajax请求，从微信服务器上获取附件转存到本地服务器上\n            Ext.Ajax.request({\n              url:'{#contextPath#}/weixinStoreFile.do?method=weixinStoreFile',\n              method: 'POST',\n              timeout : 300000,\n              params:{'mediaIds':tmp.toString(),'attCatCode':attCatCode,'srcId':srcId,'busNo':busNo,'orgId':orgId},\n              success: function ( result, request) {\n                if(callback)\n                  callback(Ext.JSON.decode(result.responseText));\n                Ext.Msg.alert('提示','图片上传成功！');\n                //清空已经上传的图片\n                images = {\n                  localId: [],\n                  serverId: []\n                };\n              },\n              failure: function ( result, request) {\n                Ext.Msg.alert('提示','图片上传失败！');\n                //清空已经上传的图片\n                images = {\n                  localId: [],\n                  serverId: []\n                };\n              }\n            });                        \n          }\n        }\n      }\n    });\n  }\n  wxUpload();\t\n}\n/**\n *图片预览接口 \n *attId:当前图片的id\n *attIds:预览图片列表ids\n *说明: attIds为数组(Array),并且attIds中必须包含attId;\n *attIds传空([])或者不传(null)时,此时为预览单张图片\n */\nfunction wxImagePreview(businessId){\n  var attIds = '';\n  Ext.Ajax.request({\n    url :'{#contextPath#}/main?xwl=23XRWETM8LUV&src_id='+businessId,\n    async:false,\n    method: 'POST',\n    success: function(response,options){\n      var temp = response.responseText;\n      var resp = Ext.JSON.decode(temp);\n      attIds = resp.rows;   \n      var  imageArray = [];\n      var  tmpUrl='{#wxCasUrl#}/xipAttMrgAction.do?method=down&view=1&att_id=';\n      var  firstUrl = '';\n      if(!Ext.isEmpty(attIds) && attIds.length>0){ \n        var i = 0;\n        Ext.each(attIds,function(item){\n          if(i === 0){\n            firstUrl = tmpUrl+item.ATT_ID;\n          }\n           imageArray.push(tmpUrl+item.ATT_ID);\n          i++;\n        });\n       wx.previewImage({\n          current: firstUrl,\n          urls: imageArray\n      });\n      }else{\n        Wb.message(\"你没有上传过文件，请先上传文件！\");\n        return;\n      }\n\n    },\n    failure: function(response,options){\n      Ext.Msg.alert(\"提示\",\"服务器端没有响应!\");\n    }\n  });\n}\n/**\n *微信扫码接口\n *scanQRDesc 扫码框描述信息\n */\nfunction wxScanQRCode(scanQRDesc,callback){\n  if(Ext.isEmpty(scanQRDesc)){\n    scanQRDesc = \"微信扫一扫\";\n  }\n  wx.scanQRCode({\n    desc: scanQRDesc,\n    needResult: 1,                  // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，\n    scanType: [\"qrCode\",\"barCode\"], // 可以指定扫二维码还是一维码，默认二者都有\n    success: function (res) {\n    var result = res.resultStr;     // 当needResult 为 1 时，扫码返回的结果\n      if(callback){\n          callback(result);\n      }\n}\n});\n}\n","headerHtml":"<script src=\"http://res.wx.qq.com/open/js/jweixin-1.0.0.js\"><\/script>","itemId":"weixinClientScript"},"children":[],"expanded":false,"type":"clientscript"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}