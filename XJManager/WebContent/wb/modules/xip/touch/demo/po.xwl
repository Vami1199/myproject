{"inframe":true,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"itemId":"module"},"events":{"initialize":"Wb.apply(app, {\n  xipMainNav: null,\n  isWfUsed: 'N',\n  init: function(mainNav) {\n    if (mainNav) {\n      app.xipMainNav = mainNav;\n    }\n  },\n  selPo: {\n    data: {}\n  },\n  poDtlMap: Ext.create('Ext.util.HashMap'),\n  savePoLine: function(formObj, po_l_id) {\n    var fs = app.poDtlMap.get(po_l_id);\n    var lOpType = fs.down(\"#L_OP_TYPE\").getValue();\n    var itemName = fs.down(\"#ITEM_NAME\").getValue();\n    var price = fs.down(\"#PRICE\").getValue();\n    var cnt = fs.down(\"#CNT\").getValue();\n    var amt = fs.down(\"#L_AMT\").getValue();\n    var datas = formObj.getValues();\n    var poId = datas.PO_ID;\n    var ret = 'Y';\n    if (\"U\" === lOpType) {\n      Ext.Ajax.request({\n        url: 'm?xwl=xip/wf/wfDemo/DATA/polUpdate',\n        params: {\n          array: [{\n            'PO_L_ID': po_l_id,\n            'ITEM_NAME': itemName,\n            'UNIT': '',\n            'PRICE': price,\n            'CNT': cnt,\n            'AMT': amt\n          }]\n        },\n        method: 'POST',\n        async: true,\n        success: function(response, options) {\n          ret = 'Y';\n        },\n        failure: function(response, options) {\n          ret = 'N';\n        }\n      });\n    } else {\n      Ext.Ajax.request({\n        url: 'm?xwl=xip/wf/wfDemo/DATA/polInsert',\n        params: {\n          array: [{\n            'PO_L_ID': po_l_id,\n            'ITEM_NAME': itemName,\n            'UNIT': '',\n            'PRICE': price,\n            'CNT': cnt,\n            'AMT': amt,\n            'PO_ID': poId\n          }]\n        },\n        method: 'POST',\n        async: true,\n        success: function(response, options) {\n          fs.down(\"#L_OP_TYPE\").setValue('U');\n          ret = 'Y';\n        },\n        failure: function(response, options) {\n          ret = 'N';\n        }\n      });\n    }\n    return ret;\n  },\n  delPoLine: function(formObj, po_l_id) {\n    var fs = formObj.down(\"#\"+po_l_id);\n    var lOpType = fs.down(\"#L_OP_TYPE\").getValue();\n    Wb.confirm(\"确定删除此条订单行数据吗？\", function() {\n      if (\"U\" === lOpType) {\n        //删除数据库中的记录\n        Ext.Ajax.request({\n          url: 'm?xwl=xip/touch/demo/data/polDel',\n          params: {\n            'poids': \"'\" + po_l_id + \"'\"\n          },\n          method: 'POST',\n          async: true,\n          success: function(response, options) {\n            //移除订单行所在的FieldSet控件\n            formObj.remove(fs);\n            app.poDtlMap.removeByKey(po_l_id);\n          },\n          failure: function(response, options) {}\n        });\n      } else {\n        //移除订单行所在的FieldSet控件\n        formObj.remove(fs);\n        app.poDtlMap.removeByKey(po_l_id);\n      }\n    });\n\n  },\n  savePo: function(formObj) {\n    var datas = formObj.getValues();\n    var poId = datas.PO_ID;\n    var opType = datas.OP_TYPE;\n    if (\"U\" === opType) {\n      //更新订单头\n      Ext.Ajax.request({\n        url: 'm?xwl=xip/wf/wfDemo/DATA/poUpdate',\n        params: {\n          array: [{\n            'PO_ID': datas.PO_ID,\n            'PO_NO': datas.PO_NO,\n            'PO_DESC': datas.PO_DESC,\n            'VENDOR': datas.VENDOR,\n            'ORG_ID': datas.ORG_ID,\n            'DEPT_ID': datas.DEPT_ID,\n            'BUYER': datas.BUYER,\n            'AMT': datas.AMT,\n            'PO_DATE': datas.PO_DATE\n          }]\n        },\n        method: 'POST',\n        async: true,\n        success: function(response, options) {\n          app.poDtlMap.each(function(key, value, length) {\n            app.savePoLine(formObj, key);\n          });\n          Ext.Msg.alert(\"保存数据成功\");\n        },\n        failure: function(response, options) {}\n      });\n    } else {\n      //新增订单头\n      var json = {\n        'PO_ID': datas.PO_ID,\n        'PO_NO': datas.PO_NO,\n        'PO_DESC': datas.PO_DESC,\n        'VENDOR': datas.VENDOR,\n        'ORG_ID': datas.ORG_ID,\n        'DEPT_ID': datas.DEPT_ID,\n        'BUYER': datas.BUYER,\n        'AMT': datas.AMT,\n        'PO_DATE': datas.PO_DATE\n      };\n      Wb.request({\n        url: 'm?xwl=xip/wf/wfDemo/DATA/poInsert',\n        params: Wb.apply({\n          array: [json]\n        }),\n        method: 'POST',\n        async: true,\n        success: function(response, options) {\n          formObj.setValues({\n            'OP_TYPE': 'U'\n          });\n          app.poDtlMap.each(function(key, value, length) {\n            app.savePoLine(formObj, key);\n          });\n          Ext.Msg.alert(\"保存数据成功\");\n        },\n        failure: function(response, options) {}\n      });\n    }\n  },\n  createPoLine: function(parentObj, isNew, data) {\n    var poLineToolBar = null;\n    var lineId;\n    var opType;\n    if ('Y' === isNew) {\n      lineId = Wb.getId();\n      opType = 'I';\n    } else {\n      lineId = data.PO_L_ID;\n      opType = 'U';\n    }\n    app._poLine.itemId=lineId;\n    var pl = Ext.create('Ext.form.FieldSet', app._poLine);\n    if (app.isWfUsed === 'Y') {\n      var tb = pl.down('#poLineToolBar');\n      tb.hide();\n    }\n    parentObj.add(pl);\n    pl.down(\"#ITEM_NAME\").focus();\n    app.poDtlMap.add(lineId, pl);\n    if ('N' === isNew) {\n      if ((data !== null) && (data !== undefined)) {\n        pl.down(\"#ITEM_NAME\").setValue(data.ITEM_NAME);\n        pl.down(\"#PRICE\").setValue(data.PRICE);\n        pl.down(\"#CNT\").setValue(data.CNT);\n        pl.down(\"#L_AMT\").setValue(data.AMT);\n        pl.down(\"#PO_L_ID\").setValue(lineId);\n        pl.down(\"#L_OP_TYPE\").setValue(opType);\n      }\n    } else {\n      pl.down(\"#PO_L_ID\").setValue(lineId);\n      pl.down(\"#L_OP_TYPE\").setValue(opType);\n    }\n  }\n});"},"children":[{"configs":{"html":"POP Demo","itemId":"popDemo","createInstance":"false"},"children":[],"expanded":false,"type":"tcontainer"},{"configs":{"normalName":"poHeader","itemId":"poHeader","createInstance":"false"},"children":[{"configs":{"name":"PO_NO","label":"订单编号","itemId":"PO_NO"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"name":"PO_DESC","label":"订单说明","itemId":"PO_DESC"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"name":"VENDOR","label":"供应商","itemId":"VENDOR"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"name":"BUYER","label":"采购员","itemId":"BUYER"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"displayField":"ORG_NAME","name":"ORG_ID","valueField":"ORG_ID","label":"组织","required":"true","itemId":"ORG_ID"},"events":{"change":"app.deptStore.load({\n  params: {\n    'ORG_ID': this.getValue()\n  }\n});"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xip/wf/wfDemo/DATA/orgStore"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"displayField":"DEPT_NAME","name":"DEPT_ID","valueField":"DEPT_ID","label":"部门","required":"true","itemId":"DEPT_ID"},"children":[{"configs":{"storeName":"deptStore","normalName":"deptStore","autoLoad":"false","itemId":"store","url":"m?xwl=xip/wf/wfDemo/DATA/deptStore"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"name":"AMT","label":"金额","itemId":"AMT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"name":"PO_DATE","label":"采购日期","picker":"{value:new Date()}","itemId":"PO_DATE"},"children":[],"expanded":false,"type":"tdate"},{"configs":{"name":"PO_ID","xtype":"hiddenfield","itemId":"PO_ID"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"name":"OP_TYPE","xtype":"hiddenfield","itemId":"OP_TYPE"},"children":[],"expanded":false,"type":"ttext"}],"expanded":true,"type":"tfieldset"},{"configs":{"normalName":"poLine","itemId":"poLine","createInstance":"false"},"children":[{"configs":{"docked":"top","itemId":"poLineToolBar"},"children":[{"configs":{"text":"保存订单行","itemId":"btn_savePoLine"},"events":{"tap":"var poLineFS =button.getParent().getParent();\nvar poForm = poLineFS.up(\"#poDtlForm\");\nvar po_l_id = poLineFS.down(\"#PO_L_ID\").getValue();\nvar ret = app.savePoLine(poForm, po_l_id);\nif (ret === 'Y') {\n  Ext.Msg.alert(\"订单行保存成功\");\n}"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"删除订单行","itemId":"btn_delPoLine"},"events":{"tap":"var poLineFS = button.getParent().getParent();\nvar poForm = poLineFS.up(\"#poDtlForm\");\nvar po_l_id = poLineFS.down(\"#PO_L_ID\").getValue();\napp.delPoLine(poForm, po_l_id);"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"},{"configs":{"name":"ITEM_NAME","label":"物资名称","itemId":"ITEM_NAME"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"name":"PRICE","label":"单价","itemId":"PRICE"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"name":"CNT","label":"数量","itemId":"CNT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"name":"L_AMT","label":"金额","itemId":"L_AMT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"name":"PO_L_ID","xtype":"hiddenfield","itemId":"PO_L_ID"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"name":"L_OP_TYPE","xtype":"hiddenfield","itemId":"L_OP_TYPE"},"children":[],"expanded":false,"type":"ttext"}],"expanded":true,"type":"tfieldset"},{"configs":{"title":"订单明细","layout":"fit","itemId":"poDtl","createInstance":"false"},"events":{"activate":"var poForm = container.down('#poDtlForm');\npoForm.removeAll();\napp.poDtlMap.clear();\nvar poH = Ext.create(\"Ext.form.FieldSet\", app._poHeader);\npoForm.add(poH);\npoForm.setValues(app.selPo.data);\nif (app.selPo.data.OP_TYPE === 'U') {\n  Ext.Ajax.request({\n    url: 'm?xwl=xip/wf/wfDemo/DATA/poListStore',\n    params: {\n      'poid': app.selPo.data.PO_ID\n    },\n    method: 'POST',\n    async: true,\n    success: function(response, options) {\n      var resp = Ext.JSON.decode(response.responseText);\n      if ((resp.success === true) && (resp.total > 0)) {\n        var datas = resp.rows;\n        Ext.each(datas, function(data, index) {\n          app.createPoLine(poForm, 'N', data);\n        });\n      }\n    },\n    failure: function(response, options) {}\n  });\n}\nif (app.isWfUsed === 'Y') {\n  var tb = container.down('#poLineToolBar');\n  tb.hide();\n}"},"children":[{"configs":{"itemId":"poDtlForm"},"children":[],"expanded":false,"type":"tform"},{"configs":{"docked":"bottom","itemId":"poLineToolBar"},"children":[{"configs":{"text":"新增行","itemId":"btn_newLine"},"events":{"tap":"var podtl = button.up('#poDtl');\nvar poForm = podtl.down('#poDtlForm');\napp.createPoLine(poForm,'Y',null);"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"保存","itemId":"btn_save"},"events":{"tap":"var poDtl = button.up('#poDtl');\nvar poForm = poDtl.down('#poDtlForm');\napp.savePo(poForm);"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"}],"expanded":true,"type":"tcontainer"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}