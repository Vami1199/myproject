{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"initScript":"var insCode = request.getParameter(\"instanceCode\");\nvar businessId = request.getParameter(\"businessId\");\nvar userName = request.getParameter(\"username\");\n\nrequest.setAttribute(\"insCode\",insCode);\nrequest.setAttribute(\"poid\",businessId);\nrequest.setAttribute(\"userName\",userName);","loginRequired":"false","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xip/wf/wfDemo/json/wf_wfDemo\");","itemId":"module"},"children":[{"configs":{"params":"{poid:'{#poid#}'}","itemId":"formStore","url":"m?xwl=xip/wf/wfDemo/data_vp/queryform"},"events":{"load":"if(app.formStore.getAt(0)) {\n  //app.newWinForm.loadRecord(app.formStore.getAt(0));\n  app.PO_NO.setValue(app.formStore.getAt(0).get(\"PO_NO\"));\n  app.PO_DESC.setValue(app.formStore.getAt(0).get(\"PO_DESC\"));\n  app.VENDOR.setValue(app.formStore.getAt(0).get(\"VENDOR\"));\n  app.BUYER.setValue(app.formStore.getAt(0).get(\"BUYER\"));\n  app.ORG_NAME.setValue(app.formStore.getAt(0).get(\"ORG_NAME\"));\n  app.DEPT_NAME.setValue(app.formStore.getAt(0).get(\"DEPT_NAME\"));\n  app.AMT.setValue(app.formStore.getAt(0).get(\"AMT\"));\n  app.PO_DATE.setValue(app.formStore.getAt(0).get(\"PO_DATE\"));\n  app.ORG_ID.setValue(app.formStore.getAt(0).get(\"ORG_ID\"));\n  app.DEPT_ID.setValue(app.formStore.getAt(0).get(\"DEPT_ID\"));\n}"},"children":[],"expanded":false,"type":"store"},{"configs":{"layout":"fit","itemId":"viewport1"},"events":{"afterrender":"app.formStore.load();"},"children":[{"configs":{"style":"border-width:0px;","layout":"border","itemId":"panel4"},"children":[{"configs":{"region":"north","height":"80","frame":"true","style":"border-width:0px;","layout":"form","border":"false","itemId":"newWinForm"},"children":[{"configs":{"style":"border-width:0px","hidden":"true","border":"false","itemId":"tbar"},"children":[{"configs":{"text":"{#wf_wfDemo_saveAllbtn#}","pressed":"false","itemId":"saveAllbtn","iconCls":"save_icon"},"events":{"click":"if(curPoid===\"\"){\n  curPoid = Wb.getId();\n  var val = app.PO_NO.getValue();\n  var now = new Date();\n  var lastdate = now;\n  var podate = app.PO_DATE.getValue();\n  var json={PO_ID\t:\tcurPoid,\n            PO_NO\t:\tapp.PO_NO.getValue(),\n            PO_DESC\t:\tapp.PO_DESC.getValue(),\n            VENDOR\t:\tapp.VENDOR.getValue(),\n            ORG_ID\t:\tapp.ORG_ID.getValue(),\n            DEPT_ID\t:\tapp.DEPT_ID.getValue(),\n            BUYER\t:\tapp.BUYER.getValue(),\n            AMT\t\t:\tapp.AMT.getValue(),\n            PO_DATE\t:\tpodate,\n            CREATION_DATE\t:\tlastdate,\n            CREATED_BY\t\t:\tuserId,\n            LAST_UPDATE_DATE:\tlastdate,\n            LAST_UPDATED_BY\t:\tuserId,\n            LAST_UPDATE_LOGIN\t:\tuserId\n           };\n  // 提交请求  插入主表\n  Wb.request({\n    url: 'm?xwl=xip/wf/wfDemo/DATA/poInsert', \n    params: Wb.apply({\n      array: [json]\n    }),\n    success: function() {\n      //插入或更新子表\n      var recs = app.newWinGrid.store.getCount();\n      if(recs===0){\n          app.newWindow.close();\n          app.newWinGrid.store.load();\n      }else{ \n          for(var i=0;i<recs;i++){\n                var rec =  app.newWinGrid.store.getAt(i);\n                if(rec.data.PO_L_ID ===''||rec.data.PO_L_ID === null){\n                 //插入子表\n                 var json_l={\n                           PO_L_ID : Wb.getId(),\n                           PO_ID   : curPoid,\n                           ITEM_NAME:rec.data.ITEM_NAME,\n                           UNIT    : rec.data.UNIT,\n                           PRICE   : rec.data.PRICE,\n                           CNT     : rec.data.CNT,\n                           AMT     : rec.data.AMT,\n                           CREATION_DATE :  new Date(),\n                           CREATED_BY    :  userId,\n                           LAST_UPDATE_DATE: new Date(),\n                           LAST_UPDATED_BY:  userId,\n                           LAST_UPDATE_LOGIN: userId};\n         Wb.request({\n           url: 'm?xwl=xip/wf/wfDemo/DATA/polInsert', \n           params: Wb.apply({\n                array: [json_l]\n           }),\n           success: function() {\n           }\n        });\n       }else{\n          //更新子表\n          var json_l_update={\n                    PO_L_ID  :   Wb.getId(),\n                    ITEM_NAME:   rec.data.ITEM_NAME,\n                    UNIT     :   rec.data.UNIT,\n                    PRICE    :   rec.data.PRICE,\n                    CNT      :   rec.data.CNT,\n                    AMT      :   rec.data.AMT,\n                    LAST_UPDATE_DATE :   new Date(),\n                    LAST_UPDATED_BY  :   userId,\n                    LAST_UPDATE_LOGIN:   userId};\n           Wb.request({\n              url: 'm?xwl=xip/wf/wfDemo/DATA/polUpdate', \n              params: Wb.apply({\n                  array: [json_l_update]\n              }),\n              success: function(){\n              \n              }\n           });\n       } \n     }\n    \n}\n       app.newWindow.close();\n      app.grid1.store.load();\n      \n    }\n  });\n}else{\n  var podate = app.PO_DATE.getValue();\n  var json={PO_ID  : curPoid,\n            PO_NO  : app.PO_NO.getValue(),\n            PO_DESC: app.PO_DESC.getValue(),\n            VENDOR : app.VENDOR.getValue(),\n            ORG_ID : app.ORG_ID.getValue(),\n            DEPT_ID: app.DEPT_ID.getValue(),\n            BUYER  : app.BUYER.getValue(),\n            AMT    : app.AMT.getValue(),\n            PO_DATE: podate,\n            LAST_UPDATE_DATE : lastdate,\n            LAST_UPDATED_BY  : userId,\n            LAST_UPDATE_LOGIN: userId\n           };\n  // 提交请求 保存主表\n  Wb.request({\n    url: 'm?xwl=xip/wf/wfDemo/DATA/poUpdate', \n    params: Wb.apply({\n      array: [json]\n    }),\n    success: function() {\n      //保存子表 判断更新还是插入\n      var recs = app.newWinGrid.store.getCount();\n      if(recs === 0){\n         app.newWindow.close();\n         app.newWinGrid.store.load();\n      }else{ \n         for(var i=0;i<recs;i++){\n           var rec = app.newWinGrid.store.getAt(i);\n           if(rec.data.PO_L_ID === ''||rec.data.PO_L_ID === null){\n            var json={\n                PO_L_ID\t\t\t\t:\tWb.getId(),\n                PO_ID\t\t\t\t:\tcurPoid,\n                ITEM_NAME\t\t\t:\trec.data.ITEM_NAME,\n                UNIT\t\t\t\t:\trec.data.UNIT,\n                PRICE\t\t\t\t:\trec.data.PRICE,\n                CNT\t\t\t\t\t:\trec.data.CNT,\n                AMT\t\t\t\t\t:\trec.data.AMT,\n                CREATION_DATE\t\t:\tnew Date(),\n                CREATED_BY\t\t\t:\tuserId,\n                LAST_UPDATE_DATE\t:\tnew Date(),\n                LAST_UPDATED_BY\t\t:\tuserId,\n                LAST_UPDATE_LOGIN\t:\tuserId};\n        Wb.request({\n           url: 'm?xwl=xip/wf/wfDemo/DATA/polInsert', \n           params: Wb.apply({\n             array: [json]\n           }),\n           success: function() {\n      \n           }\n       });\n        }else{\n           var json_l_update={\n                PO_L_ID\t\t\t\t:\trec.data.PO_L_ID,\n                ITEM_NAME\t\t\t:\trec.data.ITEM_NAME,\n                UNIT\t\t\t\t:\trec.data.UNIT,\n                PRICE\t\t\t\t:\trec.data.PRICE,\n                CNT\t\t\t\t\t:\trec.data.CNT,\n                AMT\t\t\t\t\t:\trec.data.AMT,\n                LAST_UPDATE_DATE\t:\tnew Date(),\n                LAST_UPDATED_BY\t\t:\tuserId,\n                LAST_UPDATE_LOGIN\t:\tuserId};\n         Wb.request({\n           url: 'm?xwl=xip/wf/wfDemo/DATA/polUpdate', \n           params: Wb.apply({\n              array: [json_l_update]\n            }),\n           success: function() {\n           }\n       });\n     } \n  }\n \n} app.newWindow.close();\n  app.grid1.store.load();\n      \n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"height":"30","frame":"true","style":"border-width:0px","layout":"column","border":"false","itemId":"panel1"},"children":[{"configs":{"labelWidth":"70","width":"200","labelAlign":"right","itemId":"PO_NO","fieldLabel":"{#wf_wfDemo_PO_NO#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"70","width":"200","labelAlign":"right","itemId":"PO_DESC","fieldLabel":"{#wf_wfDemo_PO_DESC#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"70","width":"200","labelAlign":"right","itemId":"VENDOR","fieldLabel":"{#wf_wfDemo_VENDOR#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"70","width":"200","labelAlign":"right","itemId":"BUYER","fieldLabel":"{#wf_wfDemo_BUYER#}"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"},{"configs":{"height":"30","frame":"true","style":"border-width:0px","layout":"column","border":"false","itemId":"panel2"},"children":[{"configs":{"labelWidth":"70","width":"175","labelAlign":"right","itemId":"ORG_NAME","fieldLabel":"{#wf_wfDemo_ORG_NAME_01#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"width":"25","itemId":"orgBtn","iconCls":"set_icon"},"events":{"click":"app.orgWin.show();\napp.orgGrid.store.load();"},"children":[],"expanded":false,"type":"button"},{"configs":{"labelWidth":"70","width":"175","labelAlign":"right","itemId":"DEPT_NAME","fieldLabel":"{#wf_wfDemo_DEPT_NAME_01#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"width":"25","itemId":"deptBtn","iconCls":"set_icon"},"events":{"click":"var orgname=app.ORG_NAME.getValue();\nif(orgname !==\"\" &&  orgname !==null){\n  app.deptWin.show();\n  app.deptGrid.store.reload();\n}else{\n//    Ext.Msg.alert('提示', '请先选择组织' );\n  Ext.Msg.alert(\"{#wf_wfDemo_prompt#}\",\"{#wf_wfDemo_qxxzzz#}\") ;\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"labelWidth":"70","readOnly":"true","width":"200","labelAlign":"right","itemId":"AMT","fieldLabel":"{#wf_wfDemo_AMT#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"70","width":"200","value":"@new Date()","labelAlign":"right","itemId":"PO_DATE","fieldLabel":"{#wf_wfDemo_PO_DATE#}"},"children":[],"expanded":false,"type":"date"}],"expanded":false,"type":"panel"},{"configs":{"height":"30","frame":"true","hidden":"true","layout":"column","border":"false","itemId":"panel3"},"children":[{"configs":{"labelWidth":"80","width":"220","labelAlign":"right","itemId":"ORG_ID","fieldLabel":"组织ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","width":"220","labelAlign":"right","itemId":"DEPT_ID","fieldLabel":"部门ID"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","multiSelect":"true","itemId":"newWinGrid","editable":"true"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"align":"center","xtype":"rownumberer","itemId":"XUHAO "},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#wf_wfDemo_PO_ID#}","hidden":"true","dataIndex":"PO_ID","itemId":"PO_ID_M_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#wf_wfDemo_PO_L_ID#}","hidden":"true","dataIndex":"PO_L_ID","itemId":"PO_L_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#wf_wfDemo_ITEM_NAME#}","width":"200","dataIndex":"ITEM_NAME","itemId":"ITEM_NAME_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"column"},{"configs":{"text":"{#wf_wfDemo_UNIT#}","width":"80","dataIndex":"UNIT","itemId":"UNIT_COL","renderer":"if(value=='T'){\n  return '{#wf_wfDemo_tai#}';\n} else if(value=='G'){\n  return '{#wf_wfDemo_ge#}';\n} else if(value=='X'){\n  return '{#wf_wfDemo_xiang#}';\n} else {\n  return value;\n}"},"children":[{"configs":{"pickList":"[['T','{#wf_wfDemo_tai#}'],['G','{#wf_wfDemo_ge#}'],['X','{#wf_wfDemo_xiang#}']]","itemId":"editor","forceSelection":"true"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"column"},{"configs":{"text":"{#wf_wfDemo_PRICE#}","width":"120","dataIndex":"PRICE","itemId":"PRICE_COL"},"children":[{"configs":{"itemId":"editor"},"events":{"blur":"var selectRecord = app.newWinGrid.getSelection();\n//var selectRecord = app.newWinGrid.store.getAt(clickRowNum);\n\nvar price = this.getValue();\nif(Ext.isEmpty(price)){\n  price = 0;\n}\n\nvar count = selectRecord[0].get('CNT');\nif(Ext.isEmpty(count)){\n  count = 0;\n}\n\nselectRecord[0].set('AMT',price * count);\n\nsumAmt();"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"{#wf_wfDemo_CNT#}","width":"120","dataIndex":"CNT","itemId":"CNT_COL"},"children":[{"configs":{"itemId":"editor"},"events":{"blur":"//var selectRecord = app.newWinGrid.store.getAt(clickRowNum);\nvar selectRecord = app.newWinGrid.getSelection();\nvar price = selectRecord[0].get('PRICE');\nif(Ext.isEmpty(price)){\n  price = 0;\n}\n\nvar count = this.getValue();\nif(Ext.isEmpty(count)){\n  count = 0;\n}\n\nselectRecord[0].set('AMT',price * count);\n\nsumAmt();"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"{#wf_wfDemo_AMT_01#}","width":"120","dataIndex":"AMT","itemId":"AMT_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"pageSize":"-1","params":"{poid:'{#poid#}'}","autoLoad":"true","itemId":"store","url":"m?xwl=xip/wf/wfDemo/data_vp/queryGrid"},"events":{"beforeload":"// var rows = app.grid1.getSelection();\n// alert(rows[0].data.PO_ID);\n// store.getProxy().extraParams.poid = rows[0].data.PO_ID;"},"children":[],"expanded":false,"type":"store"},{"configs":{"hidden":"true","itemId":"tbar"},"children":[{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#wf_wfDemo_addBtn#}","pressed":"false","itemId":"addBtn","iconCls":"record_add_icon"},"events":{"click":"Wb.addEdit(app.newWinGrid);"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item2"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#wf_wfDemo_deleteBtn#}","pressed":"false","itemId":"deleteBtn","iconCls":"record_delete_icon"},"events":{"click":"var recs = app.newWinGrid.getSelection();\nif (!recs.length) {\n  //Wb.warn('请选择需要删除的记录。');\n\tWb.warn('{#wf_wfDemo_qxzxyscdjl#}');\n\treturn;\n}\nWb.request({\n        url: 'm?xwl=xip/wf/wfDemo/DATA/poldel', \n        params: Wb.apply({\n           destroy: Wb.getData(recs)\n        }),\n        success: function() {\n          Wb.remove(app.newWinGrid);\n//           Ext.Msg.alert('提示','删除成功！');\n          Ext.Msg.alert(\"{#wf_wfDemo_prompt#}\",\"{#wf_wfDemo_sccg#}\") ;\n        }\n      });\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item3"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}